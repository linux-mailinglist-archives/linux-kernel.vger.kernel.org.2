Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id C4F353779F8
	for <lists+linux-kernel@lfdr.de>; Mon, 10 May 2021 03:52:17 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230158AbhEJBvA convert rfc822-to-8bit (ORCPT
        <rfc822;lists+linux-kernel@lfdr.de>); Sun, 9 May 2021 21:51:00 -0400
Received: from regular1.263xmail.com ([211.150.70.198]:51230 "EHLO
        regular1.263xmail.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230119AbhEJBu7 (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 9 May 2021 21:50:59 -0400
Received: from localhost (unknown [192.168.167.69])
        by regular1.263xmail.com (Postfix) with ESMTP id B663E721;
        Mon, 10 May 2021 09:49:11 +0800 (CST)
X-MAIL-GRAY: 0
X-MAIL-DELIVERY: 1
X-ADDR-CHECKED4: 1
X-ANTISPAM-LEVEL: 2
X-SKE-CHECKED: 1
X-ABS-CHECKED: 1
Received: from manjaro.uniontech.com (unknown [58.246.122.242])
        by smtp.263.net (postfix) whith ESMTP id P19990T140047247578880S1620611350997414_;
        Mon, 10 May 2021 09:49:11 +0800 (CST)
X-IP-DOMAINF: 1
X-UNIQUE-TAG: <25582c515e01310e114fb80fc20a4e83>
X-RL-SENDER: chenli@uniontech.com
X-SENDER: chenli@uniontech.com
X-LOGIN-NAME: chenli@uniontech.com
X-FST-TO: akpm@linux-foundation.org
X-RCPT-COUNT: 6
X-SENDER-IP: 58.246.122.242
X-ATTACHMENT-NUM: 0
X-System-Flag: 0
Date:   Mon, 10 May 2021 09:49:11 +0800
Message-ID: <87tunb2wa0.wl-chenli@uniontech.com>
From:   Chen Li <chenli@uniontech.com>
To:     akpm@linux-foundation.org
Cc:     mm-commits@vger.kernel.org, David Hildenbrand <david@redhat.com>,
        Matthew Wilcox <willy@infradead.org>, linux-mm@kvack.org,
        linux-kernel@vger.kernel.org
Subject: [PATCH v2] nommu: remove __GFP_HIGHMEM in vmalloc/vzalloc
In-Reply-To: <20210509041323.k6DtiMDiu%akpm@linux-foundation.org>
References: <20210509041323.k6DtiMDiu%akpm@linux-foundation.org>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?ISO-8859-4?Q?Goj=F2?=) APEL-LB/10.8 EasyPG/1.0.0
 Emacs/28.0.50 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 8BIT
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Sun, 09 May 2021 12:13:23 +0800,
akpm@linux-foundation.org wrote:
> 
> 
> The patch titled
>      Subject: nommu-remove-__gfp_highmem-in-vmalloc-vzalloc-checkpatch-fixes
> has been added to the -mm tree.  Its filename is
>      nommu-remove-__gfp_highmem-in-vmalloc-vzalloc-checkpatch-fixes.patch
> 
> This patch should soon appear at
>     https://ozlabs.org/~akpm/mmots/broken-out/nommu-remove-__gfp_highmem-in-vmalloc-vzalloc-checkpatch-fixes.patch
> and later at
>     https://ozlabs.org/~akpm/mmotm/broken-out/nommu-remove-__gfp_highmem-in-vmalloc-vzalloc-checkpatch-fixes.patch
> 
> Before you just go and hit "reply", please:
>    a) Consider who else should be cc'ed
>    b) Prefer to cc a suitable mailing list as well
>    c) Ideally: find the original patch on the mailing list and do a
>       reply-to-all to that, adding suitable additional cc's
> 
> *** Remember to use Documentation/process/submit-checklist.rst when testing your code ***
> 
> The -mm tree is included into linux-next and is updated
> there every 3-4 working days
> 
> ------------------------------------------------------
> From: Andrew Morton <akpm@linux-foundation.org>
> Subject: nommu-remove-__gfp_highmem-in-vmalloc-vzalloc-checkpatch-fixes
> 
> Cc: Chen Li <chenli@uniontech.com>
> 
> WARNING: please, no spaces at the start of a line
> #37: FILE: mm/nommu.c:226:
> +       return __vmalloc(size, GFP_KERNEL);$
> 
> total: 0 errors, 1 warnings, 16 lines checked
> 
> NOTE: For some of the reported defects, checkpatch may be able to
>       mechanically convert to the typical style using --fix or --fix-inplace.
> 
> ./patches/nommu-remove-__gfp_highmem-in-vmalloc-vzalloc.patch has style problems, please review.
> 
> NOTE: If any of the errors are false positives, please report
>       them to the maintainer, see CHECKPATCH in MAINTAINERS.
> 
> Please run checkpatch prior to sending patches
> 
> Cc: Chen Li <chenli@uniontech.com>
> Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
> ---
> 
>  mm/nommu.c |    2 +-
>  1 file changed, 1 insertion(+), 1 deletion(-)
> 
> --- a/mm/nommu.c~nommu-remove-__gfp_highmem-in-vmalloc-vzalloc-checkpatch-fixes
> +++ a/mm/nommu.c
> @@ -223,7 +223,7 @@ long vread(char *buf, char *addr, unsign
>   */
>  void *vmalloc(unsigned long size)
>  {
> -       return __vmalloc(size, GFP_KERNEL);
> +	return __vmalloc(size, GFP_KERNEL);
>  }
>  EXPORT_SYMBOL(vmalloc);
>  
> _
> 
> Patches currently in -mm which might be from akpm@linux-foundation.org are
> 
> mm.patch
> mm-gup-pack-has_pinned-in-mmf_has_pinned-checkpatch-fixes.patch
> mm-memcg-optimize-user-context-object-stock-access-checkpatch-fixes.patch
> nommu-remove-__gfp_highmem-in-vmalloc-vzalloc-checkpatch-fixes.patch
> linux-next-git-rejects.patch
> kernel-forkc-export-kernel_thread-to-modules.patch
> 
> 
> 

From mm/nommu.c:
void *__vmalloc(unsigned long size, gfp_t gfp_mask)
{
	/*
	 *  You can't specify __GFP_HIGHMEM with kmalloc() since kmalloc()
	 * returns only a logical address.
	 */
	return kmalloc(size, (gfp_mask | __GFP_COMP) & ~__GFP_HIGHMEM);
}

__vmalloc just elimitate __GFP_HIGHMEM, so it makes no sense to add
__GFP_HIGHMEM for nommu's vmalloc/vzalloc.

changelog:
 *v2: Also fix a space style warning reported from checkpatch, which is
      introduced via commit 1da177e4c3f4 ("Linux-2.6.12-rc2")

Signed-off-by: Chen Li <chenli@uniontech.com>
Reviewed-by: Matthew Wilcox (Oracle) <willy@infradead.org>
Reviewed-by: David Hildenbrand <david@redhat.com>
---
 mm/nommu.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/mm/nommu.c b/mm/nommu.c
index 5c9ab799c0e6..f1794e818348 100644
--- a/mm/nommu.c
+++ b/mm/nommu.c
@@ -233,7 +233,7 @@ long vwrite(char *buf, char *addr, unsigned long count)
  */
 void *vmalloc(unsigned long size)
 {
-       return __vmalloc(size, GFP_KERNEL | __GFP_HIGHMEM);
+	return __vmalloc(size, GFP_KERNEL);
 }
 EXPORT_SYMBOL(vmalloc);
 
@@ -251,7 +251,7 @@ EXPORT_SYMBOL(vmalloc);
  */
 void *vzalloc(unsigned long size)
 {
-	return __vmalloc(size, GFP_KERNEL | __GFP_HIGHMEM | __GFP_ZERO);
+	return __vmalloc(size, GFP_KERNEL | __GFP_ZERO);
 }
 EXPORT_SYMBOL(vzalloc);
 
-- 
2.31.1



