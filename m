Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 2A28238F6E3
	for <lists+linux-kernel@lfdr.de>; Tue, 25 May 2021 02:14:08 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229896AbhEYAPe (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Mon, 24 May 2021 20:15:34 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:52104 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229539AbhEYAPe (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 24 May 2021 20:15:34 -0400
Received: from mail-ed1-x533.google.com (mail-ed1-x533.google.com [IPv6:2a00:1450:4864:20::533])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 31661C061574
        for <linux-kernel@vger.kernel.org>; Mon, 24 May 2021 17:14:05 -0700 (PDT)
Received: by mail-ed1-x533.google.com with SMTP id b17so34025814ede.0
        for <linux-kernel@vger.kernel.org>; Mon, 24 May 2021 17:14:05 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=from:to:cc:subject:date:message-id:mime-version
         :content-transfer-encoding;
        bh=YpLETO2kegr5zaqwxVuMFc+jL2gq1zcvvCi89cGTXjA=;
        b=S6p0we3vjgutYm8K3vYy0CEZf0Y4ENmWA685eGh39GimTJqdXqzizuhYdf69bkfIBf
         TO45xGWyLmdbS7eTxU8pjN7M8RW1ajjMYctm8Hnzl8pE2DvZ3O23ARltmLaFJrCyLNr3
         IzBBpMLLIbciG38e7hmk7ETxWgfMaTQap6dKayMXy6IgREtJh9EFZxN5afn8AUL6ra2J
         +8snK9wIlfnHeAqH4L3O8ifEY1INverjg9wopsp353Ua+B4yV0bz79exq17Yfb8n2w5B
         3NDXbXMdLs+PW7FdfmmpZAZ9mXu124O6QrK575q8I6qtu5sgtPd0N3j+Dj1WcSbpCsr6
         Kxug==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:mime-version
         :content-transfer-encoding;
        bh=YpLETO2kegr5zaqwxVuMFc+jL2gq1zcvvCi89cGTXjA=;
        b=hHQ8Fhal6uFr50kBNgMjTNtsX4tv9XGMmhB1+7pARHgwQ9LM58QO3yiH6XenA1KHVD
         OxWDZJ9zKEPM73XTWM0YjyHBZK6phw+05UcFP7h8kDVYbhGDSkROlyj4htfis7z5ditQ
         a0JjPDJof/tGB+4/25ZFOpIdVPjW3bxSajbSgi3feWdZzHwOUDqbvJHE4l/JNEifrlzz
         i/OtkTG1xKHAUR0FlahH73RB6Kjoi933saEgPjzXeTW22HUK7T2RD/4WTkOW6YlwPXbm
         vwuWMgaMy9ayBKgorjipNGHrnbkK4n3aZmw418ZcQATPy6ot5JpxNkmsnsYjF72nEkHO
         bEPA==
X-Gm-Message-State: AOAM533wlouwSpo/GBueViFGUWvmrwgs6zJExX9QYcAG4wCq9MIg0kOE
        avNqnOAR+xsK8Y1r9j6u0FI=
X-Google-Smtp-Source: ABdhPJzaXdvjJUuRn3vv1IWI2k4XUdNRCFCN4hPRNqIh/gAUUCiTVSCww1e6fsQb70rDM5CZlifsxA==
X-Received: by 2002:aa7:d659:: with SMTP id v25mr28785038edr.271.1621901643628;
        Mon, 24 May 2021 17:14:03 -0700 (PDT)
Received: from Ansuel-xps.localdomain (93-35-189-2.ip56.fastwebnet.it. [93.35.189.2])
        by smtp.googlemail.com with ESMTPSA id rn2sm8390599ejb.45.2021.05.24.17.14.02
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 24 May 2021 17:14:03 -0700 (PDT)
From:   Ansuel Smith <ansuelsmth@gmail.com>
To:     Lee Jones <lee.jones@linaro.org>, Arnd Bergmann <arnd@arndb.de>,
        linux-kernel@vger.kernel.org
Cc:     Ansuel Smith <ansuelsmth@gmail.com>
Subject: [PATCH] mfd: syscon: Fix leak of syscon name
Date:   Tue, 25 May 2021 02:13:51 +0200
Message-Id: <20210525001351.10300-1-ansuelsmth@gmail.com>
X-Mailer: git-send-email 2.31.1
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

regmap_init_mmio duplicate the name and never free the provided name in
the sysconf_config. Always free the name instead of freeing only on
error to fix error from kmemleak generated by any syscon user.

Signed-off-by: Ansuel Smith <ansuelsmth@gmail.com>
---
 drivers/mfd/syscon.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/mfd/syscon.c b/drivers/mfd/syscon.c
index c6f139b2e0c0..765c0210cb52 100644
--- a/drivers/mfd/syscon.c
+++ b/drivers/mfd/syscon.c
@@ -108,6 +108,7 @@ static struct syscon *of_syscon_register(struct device_node *np, bool check_clk)
 	syscon_config.max_register = resource_size(&res) - reg_io_width;
 
 	regmap = regmap_init_mmio(NULL, base, &syscon_config);
+	kfree(syscon_config.name);
 	if (IS_ERR(regmap)) {
 		pr_err("regmap init failed\n");
 		ret = PTR_ERR(regmap);
@@ -144,7 +145,6 @@ static struct syscon *of_syscon_register(struct device_node *np, bool check_clk)
 	regmap_exit(regmap);
 err_regmap:
 	iounmap(base);
-	kfree(syscon_config.name);
 err_map:
 	kfree(syscon);
 	return ERR_PTR(ret);
-- 
2.31.1

