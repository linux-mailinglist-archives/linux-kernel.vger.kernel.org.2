Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id F33D445F153
	for <lists+linux-kernel@lfdr.de>; Fri, 26 Nov 2021 17:08:54 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1378256AbhKZQME (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Fri, 26 Nov 2021 11:12:04 -0500
Received: from shark2.inbox.lv ([194.152.32.82]:55402 "EHLO shark2.inbox.lv"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1345470AbhKZQKD (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 26 Nov 2021 11:10:03 -0500
Received: from shark2.inbox.lv (localhost [127.0.0.1])
        by shark2-out.inbox.lv (Postfix) with ESMTP id BE764C015F;
        Fri, 26 Nov 2021 18:06:48 +0200 (EET)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=inbox.lv; s=30062014;
        t=1637942808; bh=LYlfqfN/p4CoI7DBXi0f/WvkxvZ8vxrtupJd2Moz1GE=;
        h=Date:From:To:Cc:Subject:In-Reply-To:References;
        b=e82Cz+Vs0qcVfHadb82UAp86h3VUBxxvjbQ6I5cBEPkmJNV35PKvqXeXLytDok3+A
         KLS5S+MFqv1MqPLqLQQwFVHJfBk8tfU9QzMuu6oGPmdMvIGk/7G/Vnhx1rcWCJVPSd
         RhaRc0lbAXg3Bri3yi4jLq7rb9pKq8rwC4jA6EC8=
Received: from localhost (localhost [127.0.0.1])
        by shark2-in.inbox.lv (Postfix) with ESMTP id B09B0C0143;
        Fri, 26 Nov 2021 18:06:48 +0200 (EET)
Received: from shark2.inbox.lv ([127.0.0.1])
        by localhost (shark2.inbox.lv [127.0.0.1]) (spamfilter, port 35)
        with ESMTP id 7LvLnqRdlLUp; Fri, 26 Nov 2021 18:06:48 +0200 (EET)
Received: from mail.inbox.lv (pop1 [127.0.0.1])
        by shark2-in.inbox.lv (Postfix) with ESMTP id E0292C00F6;
        Fri, 26 Nov 2021 18:06:47 +0200 (EET)
Date:   Sat, 27 Nov 2021 01:06:31 +0900
From:   Alexey Avramov <hakavlad@inbox.lv>
To:     Mel Gorman <mgorman@techsingularity.net>
Cc:     linux-mm@kvack.org, linux-kernel@vger.kernel.org, mhocko@suse.com,
        vbabka@suse.cz, neilb@suse.de, akpm@linux-foundation.org,
        corbet@lwn.net, riel@surriel.com, hannes@cmpxchg.org,
        david@fromorbit.com, willy@infradead.org, hdanton@sina.com,
        penguin-kernel@i-love.sakura.ne.jp, oleksandr@natalenko.name,
        kernel@xanmod.org, michael@michaellarabel.com, aros@gmx.com,
        hakavlad@gmail.com
Subject: Re: mm: 5.16 regression: reclaim_throttle leads to stall in
 near-OOM conditions
Message-ID: <20211127010631.4e33a432@mail.inbox.lv>
In-Reply-To: <20211124143303.GH3366@techsingularity.net>
References: <20211124011954.7cab9bb4@mail.inbox.lv>
        <20211124103550.GE3366@techsingularity.net>
        <20211124195449.33f31e7f@mail.inbox.lv>
        <20211124115007.GG3366@techsingularity.net>
        <20211124214443.5c179d34@mail.inbox.lv>
        <20211124143303.GH3366@techsingularity.net>
X-Mailer: Claws Mail 3.14.1 (GTK+ 2.24.31; x86_64-pc-linux-gnu)
MIME-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
X-Virus-Scanned: OK
X-ESPOL: EZqEIBwB+wpLucmiUuRh4Or6x9a2SFsiuzn4zbosmgxU9uyBr7wBfW6TGofmHgq/cWbD
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

>Please let me know if this version works any better

It's better, but not the same as 5.15.

Sometimes stall is short, sometimes is long (3 `tail /dev/zero` test):

2021-11-27 00:49:04,977: Starting psi2log, target: SYSTEM_WIDE, mode: 2, interval: 2 sec, log file: /tmpfs/1, suppress output: False
2021-11-27 00:49:04,978: PSI source dir: /proc/pressure/, source files: cpu, io, memory
2021-11-27 00:49:04,981: Process memory locked with MCL_CURRENT | MCL_FUTURE | MCL_ONFAULT
2021-11-27 00:49:04,981: ======|=============|=============|
2021-11-27 00:49:04,981:  cpu  |      io     |    memory   |
2021-11-27 00:49:04,981: ----- | ----------- | ----------- |
2021-11-27 00:49:04,982:  some |  some  full |  some  full | interval
2021-11-27 00:49:04,982: ----- | ----- ----- | ----- ----- | --------
2021-11-27 00:49:06,984:   1.5 |   8.2   7.8 |   0.0   0.0 | 2.002
2021-11-27 00:49:08,986:   1.4 |   0.8   0.8 |   0.0   0.0 | 2.002
2021-11-27 00:49:10,989:   1.6 |   4.2   3.9 |   0.0   0.0 | 2.003
2021-11-27 00:49:12,991:   1.2 |   2.2   2.1 |   0.0   0.0 | 2.002
2021-11-27 00:49:14,993:   1.0 |   0.6   0.6 |   0.0   0.0 | 2.002
2021-11-27 00:49:16,996:   1.0 |   1.3   1.2 |   0.0   0.0 | 2.002
2021-11-27 00:49:18,997:   2.1 |   0.2   0.1 |   0.0   0.0 | 2.001
2021-11-27 00:49:20,999:   1.0 |   0.6   0.4 |   0.0   0.0 | 2.003
2021-11-27 00:49:23,001:   1.2 |   1.0   0.9 |   0.0   0.0 | 2.001
2021-11-27 00:49:25,003:   0.9 |   0.0   0.0 |   0.0   0.0 | 2.003
2021-11-27 00:49:27,005:   1.0 |   0.1   0.1 |   0.0   0.0 | 2.001
2021-11-27 00:49:29,007:   1.0 |   0.3   0.2 |   0.0   0.0 | 2.002
2021-11-27 00:49:31,009:   0.9 |   2.8   2.1 |   0.0   0.0 | 2.002
2021-11-27 00:49:33,011:   1.0 |   0.1   0.1 |   0.0   0.0 | 2.003
2021-11-27 00:49:35,014:   1.1 |   0.5   0.4 |   0.0   0.0 | 2.002
2021-11-27 00:49:37,016:   1.1 |   2.8   2.6 |   0.0   0.0 | 2.002
2021-11-27 00:49:39,017:   0.8 |   0.1   0.1 |   0.0   0.0 | 2.001
2021-11-27 00:49:41,019:   0.6 |   0.0   0.0 |   0.0   0.0 | 2.002
2021-11-27 00:49:43,021:   1.0 |   0.4   0.2 |   0.0   0.0 | 2.002
2021-11-27 00:49:45,025:   1.2 |   0.4   0.2 |   0.0   0.0 | 2.004
2021-11-27 00:49:47,027:   1.0 |   4.4   4.0 |   0.0   0.0 | 2.002
2021-11-27 00:49:49,029:   0.9 |   0.1   0.1 |   0.0   0.0 | 2.001
2021-11-27 00:49:51,031:   0.9 |   0.2   0.2 |   0.0   0.0 | 2.002
2021-11-27 00:49:53,033:   1.0 |   4.6   3.2 |   0.0   0.0 | 2.002
2021-11-27 00:49:55,035:   0.8 |   0.1   0.1 |   0.0   0.0 | 2.002
2021-11-27 00:49:57,037:   0.7 |   0.0   0.0 |   0.0   0.0 | 2.002
2021-11-27 00:49:59,039:   0.9 |   0.1   0.1 |   0.0   0.0 | 2.002
2021-11-27 00:50:01,041:   0.8 |   0.0   0.0 |   0.0   0.0 | 2.002
2021-11-27 00:50:03,044:   1.0 |   3.3   3.2 |   0.0   0.0 | 2.003
2021-11-27 00:50:05,045:   1.0 |   0.1   0.0 |   0.0   0.0 | 2.001
2021-11-27 00:50:07,047:   0.9 |   0.0   0.0 |   0.0   0.0 | 2.002
2021-11-27 00:50:09,049:   0.9 |   0.4   0.4 |   0.0   0.0 | 2.002
2021-11-27 00:50:11,051:   0.9 |   0.4   0.4 |   0.0   0.0 | 2.002
2021-11-27 00:50:13,053:   0.9 |   0.1   0.1 |   0.0   0.0 | 2.003
2021-11-27 00:50:15,055:   1.1 |   0.4   0.3 |   0.0   0.0 | 2.002
2021-11-27 00:50:17,057:   1.1 |   0.0   0.0 |   0.0   0.0 | 2.002
2021-11-27 00:50:19,059:   0.9 |   6.9   6.0 |   0.0   0.0 | 2.003
2021-11-27 00:50:21,061:   1.1 |   1.5   1.4 |   0.0   0.0 | 2.001
2021-11-27 00:50:23,063:   0.9 |   3.9   3.8 |   0.0   0.0 | 2.002
2021-11-27 00:50:25,065:   0.5 |   0.0   0.0 |   0.0   0.0 | 2.002
2021-11-27 00:50:27,067:   0.4 |   0.0   0.0 |   0.0   0.0 | 2.003
2021-11-27 00:50:29,070:   0.7 |  10.0   8.8 |   8.5   8.4 | 2.003
2021-11-27 00:50:31,072:   0.1 |  89.1  76.4 |  22.6  22.5 | 2.002
2021-11-27 00:50:33,074:   0.3 |  93.6  80.0 |  30.7  30.6 | 2.002
2021-11-27 00:50:35,077:   0.7 |  90.5  76.9 |  67.7  67.3 | 2.002 <-- short stall
2021-11-27 00:50:37,079:   1.0 |  92.6  84.5 |  40.5  40.2 | 2.002
2021-11-27 00:50:39,082:   0.3 |  92.8  91.5 |   0.0   0.0 | 2.003
2021-11-27 00:50:41,084:   1.0 |  93.2  89.3 |   0.0   0.0 | 2.003
2021-11-27 00:50:43,087:   0.7 |  85.4  82.5 |   0.0   0.0 | 2.003
2021-11-27 00:50:45,089:   0.5 |  65.1  62.9 |   0.0   0.0 | 2.002
2021-11-27 00:50:47,091:   0.5 |  57.6  55.6 |   2.4   2.4 | 2.002
2021-11-27 00:50:49,093:   0.1 |  80.2  79.7 |  58.4  58.2 | 2.002
2021-11-27 00:50:51,096:   0.1 |  62.3  54.9 |  83.9  83.4 | 2.002
2021-11-27 00:50:53,096:   0.2 |  53.8  52.9 |  95.2  94.5 | 2.001
2021-11-27 00:50:55,099:   0.2 |  78.4  75.7 |  93.1  92.6 | 2.002
2021-11-27 00:50:57,101:   0.1 |  66.4  64.2 |  97.9  97.4 | 2.002
2021-11-27 00:50:59,103:   0.1 |  70.7  68.2 |  91.7  91.2 | 2.002
2021-11-27 00:51:01,105:   0.2 |  54.5  54.1 |  92.4  91.8 | 2.001
2021-11-27 00:51:03,107:   0.2 |  43.0  42.7 |  94.5  94.1 | 2.002
2021-11-27 00:51:05,109:   0.3 |  26.6  26.0 |  98.0  96.8 | 2.002
2021-11-27 00:51:07,111:   0.5 |  18.3  17.9 |  98.9  97.4 | 2.002
2021-11-27 00:51:09,114:   0.3 |  22.7  22.2 |  97.7  96.9 | 2.002
2021-11-27 00:51:11,116:   0.6 |  21.3  19.9 |  93.7  91.2 | 2.002 <-- medium stall
2021-11-27 00:51:13,117:   0.2 |  98.4  96.4 |   0.9   0.9 | 2.001
2021-11-27 00:51:15,119:   0.2 |  92.9  91.7 |   0.0   0.0 | 2.003
2021-11-27 00:51:17,121:   1.1 |  92.7  88.3 |   0.0   0.0 | 2.001
2021-11-27 00:51:19,123:   0.8 |  81.7  78.3 |   0.0   0.0 | 2.003
2021-11-27 00:51:21,125:   0.6 |  63.8  59.3 |   0.0   0.0 | 2.002
2021-11-27 00:51:23,128:   0.8 |  44.3  37.7 |   1.0   1.0 | 2.002
2021-11-27 00:51:25,130:   0.1 |  79.3  78.7 |  48.8  48.7 | 2.002
2021-11-27 00:51:27,132:   0.1 |  69.7  69.3 |  79.2  79.0 | 2.002
2021-11-27 00:51:29,135:   0.3 |  50.2  45.4 |  80.0  79.7 | 2.002
2021-11-27 00:51:31,136:   0.2 |  69.9  66.8 |  85.1  84.7 | 2.002
2021-11-27 00:51:33,139:   0.2 |  39.4  39.0 |  96.2  95.9 | 2.002
2021-11-27 00:51:35,140:   0.3 |  56.4  52.2 |  94.9  94.5 | 2.002
2021-11-27 00:51:37,143:   0.5 |  27.9  26.7 |  96.9  96.7 | 2.002
2021-11-27 00:51:39,146:   0.6 |   2.1   2.1 |  97.8  97.6 | 2.003
2021-11-27 00:51:41,149:   0.4 |   1.9   1.8 |  96.9  96.7 | 2.003
2021-11-27 00:51:43,151:   0.7 |   0.2   0.2 |  99.7  99.5 | 2.003
2021-11-27 00:51:45,153:   0.6 |   0.0   0.0 |  98.4  98.2 | 2.002
2021-11-27 00:51:47,156:   0.6 |   0.0   0.0 |  97.6  97.5 | 2.002
2021-11-27 00:51:49,159:   0.5 |   0.6   0.6 |  99.2  99.1 | 2.003
2021-11-27 00:51:51,160:   0.6 |   3.3   3.3 |  98.7  98.4 | 2.002
2021-11-27 00:51:53,163:   0.7 |   2.2   2.2 |  96.4  96.2 | 2.002
2021-11-27 00:51:55,165:   0.6 |   0.7   0.6 |  98.5  98.3 | 2.002
2021-11-27 00:51:57,167:   0.6 |   0.0   0.0 | 100.0  99.9 | 2.002
2021-11-27 00:51:59,169:   0.7 |   1.4   1.4 |  99.3  99.2 | 2.002
2021-11-27 00:52:01,172:   0.7 |   1.9   1.8 |  98.4  98.2 | 2.002
2021-11-27 00:52:03,174:   0.9 |   0.0   0.0 |  98.3  98.1 | 2.002
2021-11-27 00:52:05,177:   0.5 |   3.3   3.2 |  99.0  98.8 | 2.003
2021-11-27 00:52:07,179:   0.6 |   2.3   2.3 |  97.8  97.6 | 2.002
2021-11-27 00:52:09,181:   0.8 |   1.8   1.8 |  98.3  98.1 | 2.002
2021-11-27 00:52:11,184:   1.0 |   0.3   0.3 |  98.1  97.9 | 2.003
2021-11-27 00:52:13,187:   1.1 |   0.8   0.8 |  98.3  98.1 | 2.003
2021-11-27 00:52:15,189:   0.8 |   1.3   1.3 |  98.3  98.1 | 2.002
2021-11-27 00:52:17,191:   0.7 |   1.2   1.2 |  96.4  96.2 | 2.002
2021-11-27 00:52:19,194:   1.0 |   0.0   0.0 |  99.0  98.7 | 2.002
2021-11-27 00:52:21,197:   0.7 |   0.6   0.6 |  99.2  99.0 | 2.003
2021-11-27 00:52:23,199:   0.9 |   0.0   0.0 | 100.0  99.8 | 2.003
2021-11-27 00:52:25,202:   0.6 |   2.2   2.1 |  97.0  96.8 | 2.002
2021-11-27 00:52:27,204:   0.9 |   0.7   0.6 |  96.7  96.5 | 2.002
2021-11-27 00:52:29,207:   0.7 |   5.4   5.2 |  98.5  98.3 | 2.003
2021-11-27 00:52:31,209:   0.7 |  13.2  12.4 |  95.8  95.5 | 2.002
2021-11-27 00:52:33,212:   1.0 |  10.5   9.9 |  97.8  97.6 | 2.003
2021-11-27 00:52:35,213:   0.5 |  21.2  20.3 |  96.8  96.5 | 2.001
2021-11-27 00:52:37,215:   0.5 |   1.5   1.5 |  96.9  96.7 | 2.002
2021-11-27 00:52:39,217:   0.9 |   1.7   1.7 |  97.9  97.7 | 2.002
2021-11-27 00:52:41,220:   1.4 |   0.0   0.0 | 100.0  99.7 | 2.002
2021-11-27 00:52:43,222:   0.7 |   0.1   0.1 |  99.0  98.8 | 2.002
2021-11-27 00:52:45,224:   0.6 |   0.2   0.1 | 100.0  99.8 | 2.002
2021-11-27 00:52:47,227:   1.1 |   0.0   0.0 |  99.7  99.4 | 2.002
2021-11-27 00:52:49,229:   0.8 |   0.0   0.0 | 100.0  99.8 | 2.002
2021-11-27 00:52:51,231:   0.7 |   0.0   0.0 | 100.0  99.8 | 2.002
2021-11-27 00:53:13,283: WARNING: abnormal interval (22.052 sec), metrics may be provided incorrect
2021-11-27 00:53:13,283:   0.7 |  12.9  12.6 |  90.5  90.1 | 22.052 <-- long stall
2021-11-27 00:53:15,286:   0.2 |  91.1  88.9 |   6.0   5.9 | 2.003
2021-11-27 00:53:17,288:   0.6 |  91.5  89.2 |   0.0   0.0 | 2.003
2021-11-27 00:53:19,291:   1.2 |  93.4  87.1 |   0.0   0.0 | 2.003
2021-11-27 00:53:21,293:   1.1 |  80.7  74.4 |   0.0   0.0 | 2.002
2021-11-27 00:53:23,295:   1.1 |  76.0  71.0 |   0.0   0.0 | 2.003
2021-11-27 00:53:25,296:   1.0 |  40.0  35.9 |   0.0   0.0 | 2.001
2021-11-27 00:53:27,297:   1.0 |  27.4  25.5 |   0.0   0.0 | 2.0
